var j=Object.defineProperty;var x=(r,e)=>{for(var t in e)j(r,t,{get:e[t],enumerable:!0})};var c=class{constructor(e,t){this.name=e||"database",this.version=t||3}open(){return new Promise(function(e,t){let n=indexedDB.open(this.name,this.version);n.onsuccess=()=>{this.storage=n.result,e()},n.onerror=()=>{t(n.error)},n.onblocked=()=>{console.warn("pending till unblocked")}})}put(e,t,n){return new Promise((o,i)=>{var s;n?s=this.storage.transaction(e,"readwrite").objectStore(e).put(t,n):s=this.storage.transaction(e,"readwrite").objectStore(e).put(t),s.onsuccess=()=>{o()},s.onerror=()=>{i(s.error)}})}get(e,t){return new Promise((n,o)=>{let i=this.storage.transaction(e,"readonly").objectStore(e).put(t);i.onsuccess=()=>{n(i.result)},i.onerror=()=>{o(i.error)}})}};var y={};x(y,{hash:()=>P,match:()=>C,random:()=>S});function S(r,e){var t="";(!r||typeof r!="number")&&(r=24),(!e||typeof e!="string")&&(e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz");for(let n=0;n<r;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function C(r,e){var t;return typeof r!="string"?!1:(typeof e=="string"&&(e={"=":e}),e=e||{},t=e["="]||e["*"]||e[">"]||e["<"],r===t?!0:e["="]!==void 0?!1:(t=e["*"]||e[">"],r.slice(0,(t||"").length)===t?!0:e["*"]!==void 0?!1:e[">"]!==void 0&&e["<"]!==void 0?r>=e[">"]&&r<=e["<"]:e[">"]!==void 0&&r>=e[">"]||e["<"]!==void 0&&r<=e["<"]))}function P(r,e){if(typeof r=="string"){if(typeof e!="number"&&(e=0),!r.length)return e;var t;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),e=(e<<5)-e+t,e|=0;return e}}function a(){}Object.assign(a,{from:Array.from});a.prototype=Object.create(Array.prototype);a.prototype.toString=function(r){switch(r=r||"utf8",r){case"hex":let e=new Uint8Array(this);return[...Array(this.length).keys()].map(t=>e[t].toString(16).padStart(2,"0")).join("");case"utf8":return Array.from({length:this.length},(t,n)=>String.fromCharCode(this[n])).join("");case"base64":return btoa(this)}};async function p(r){typeof r!="string"&&(r=JSON.stringify(r));let e=await window.crypto.subtle.digest({name:"SHA-256"},new TextEncoder().encode(r));return Array.from(new Uint8Array(e))}function l(r){return Array.from({length:r.length},(e,t)=>String.fromCharCode(r[t])).join("")}function f(r){let e=atob(r),t=new Uint8Array(e.length);return Array.from({length:e.length},(n,o)=>t[o]=e.charCodeAt(o)),Array.from(t)}async function d(r,e){typeof r!="string"&&(r=JSON.stringify(r)),typeof e=="object"&&(e=e.epriv);let t={iv:Array.from(window.crypto.getRandomValues(new Uint8Array(15))),s:Array.from(window.crypto.getRandomValues(new Uint8Array(9)))},n=await p(e+l(t.s)),o=await window.crypto.subtle.importKey("jwk",{kty:"oct",k:btoa(a.from(n)).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"},{name:"AES-GCM"},!1,["encrypt","decrypt"]),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(t.iv)},o,new TextEncoder().encode(r)),s={ct:btoa(a.from(new Uint8Array(i))),iv:btoa(a.from(t.iv)),s:btoa(a.from(t.s))};return"SEA"+JSON.stringify(s)}async function g(r,e){typeof e=="object"&&(e=e.epriv),typeof r=="string"&&(r=JSON.parse(r.replace("SEA","")));let t=f(r.s),n=f(r.iv),o=f(r.ct),i=await p(e+l(t)),s=await window.crypto.subtle.importKey("jwk",{kty:"oct",k:btoa(a.from(i)).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"},{name:"AES-GCM"},!1,["encrypt","decrypt"]),u=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(n),tagLength:128},s,new Uint8Array(o));return new TextDecoder().decode(u)}async function b(){var r={};let e=await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]),t=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]),n=await window.crypto.subtle.exportKey("jwk",e.privateKey);r.priv=n.d;let o=await window.crypto.subtle.exportKey("jwk",e.publicKey);r.pub=`${o.x}.${o.y}`;let i=await window.crypto.subtle.exportKey("jwk",t.privateKey);r.epriv=i.d;let s=await window.crypto.subtle.exportKey("jwk",t.publicKey);return r.epub=`${s.x}.${s.y}`,r}function w(r,e){let[t,n]=r.split(".");var o=e!=null?{d:e}:{};return["jwk",Object.assign(o,{x:t,y:n,kty:"EC",crv:"P-256",ext:!0}),{name:"ECDH",namedCurve:"P-256"}]}async function m(r,e){typeof r=="object"&&(r=r.epub);let t=e.epub,n=e.epriv,o=w(t),i={public:await window.crypto.subtle.importKey(...o,!0,[]),name:"ECDH",namedCurve:"P-256"},s=w(t,n),u=await window.crypto.subtle.importKey(...s,!1,["deriveBits"]),v=await window.crypto.subtle.deriveBits(i,u,256),A=new Uint8Array(v),K=await window.crypto.subtle.importKey("raw",A,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return(await window.crypto.subtle.exportKey("jwk",K)).k}var h=class{constructor(e){this.storage=null;this.peers=[];var t=[];Array.isArray(e.peers)&&t.concat(e.peers),t.includes("wss://gunjs.herokuapp.com/gun")&&t.push("wss://gunjs.herokuapp.com/gun"),(typeof e.storage>"u"||typeof e.storage=="boolean"&&e.storage)&&(this.storage=new c,this.storage.open());for(let n=0;n<t.length;n++){let o=new WebSocket(t[n]);o.onopen=function(){o.send(`{"dam":"hi","#":"${y.random(9)}"}`)},this.peers.push(o)}}async put(e,t,n){await this.storage.put(e,t,n)}async get(e,t){return await this.storage.get(e,t)}},$={encrypt:d,decrypt:g},_={createPair:b,generateSecret:m};export{h as Database,$ as Encryption,_ as Security};
