!function(){return function e(t,n,r){function s(i,u){if(!n[i]){if(!t[i]){var c="function"==typeof require&&require;if(!u&&c)return c(i,!0);if(o)return o(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var h=n[i]={exports:{}};t[i][0].call(h.exports,function(e){return s(t[i][1][e]||e)},h,h.exports,e,t,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)s(r[i]);return s}}()({1:[function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var s=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==r(e)&&"function"!=typeof e)return{default:e};var n=o(t);if(n&&n.has(e))return n.get(e);var s={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var c=i?Object.getOwnPropertyDescriptor(e,u):null;c&&(c.get||c.set)?Object.defineProperty(s,u,c):s[u]=e[u]}s.default=e,n&&n.set(e,s);return s}(e("@chaingun/client"));function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(o=function(e){return e?n:t})(e)}window.ChainGunClient=s.ChainGunClient,window.GunGraph=s.GunGraph,window.ChainGunLink=s.ChainGunLink,window.GunEvent=s.GunEvent,window.GunQueue=s.GunQueue,window.GunProcessQueue=s.GunProcessQueue,window.GunGraphConnector=s.GunGraphConnector,window.GunGraphWireConnector=s.GunGraphWireConnector,window.WebSocketGraphConnector=s.WebSocketGraphConnector,window.GunGraphConnectorFromAdapter=s.GunGraphConnectorFromAdapter},{"@chaingun/client":15}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("@chaingun/crdt"),s=e("./ChainGunLink"),o=e("./Graph/GunGraph"),i=e("./Transports/WebSocketGraphConnector");n.ChainGunClient=class{constructor(e,t=s.ChainGunLink){e&&e.graph?this.graph=e.graph:(this.graph=new o.GunGraph,this.graph.use(r.diffGunCRDT),this.graph.use(r.diffGunCRDT,"write")),this._opt={},e&&this.opt(e),this.LinkClass=t}opt(e){return this._opt=Object.assign(Object.assign({},this._opt),e),e.peers&&e.peers.forEach(e=>{const t=new i.WebSocketGraphConnector(e,this._opt.WS);t.sendPutsFromGraph(this.graph),t.sendRequestsFromGraph(this.graph),this.graph.connect(t)}),this}get(e,t){return new this.LinkClass(this,e)}}},{"./ChainGunLink":3,"./Graph/GunGraph":8,"./Transports/WebSocketGraphConnector":14,"@chaingun/crdt":16}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("./ControlFlow/GunEvent");class s{constructor(e,t,n){this.key=t,n||(this.soul=t),this._opt={},this._chain=e,this._parent=n,this._hasReceived=!1,this._updateEvent=new r.GunEvent(this.getPath().join("|"))}getPath(){return this._parent?[...this._parent.getPath(),this.key]:[this.key]}get(e,t){return new this.constructor(this._chain,e,this)}back(e=1){return e<0||e===1/0?this._chain:1===e?this._parent||this._chain:this.back(e-1)}put(e,t){return this._chain.graph.putPath(this.getPath(),e,t,this.opt().uuid),this}set(e,t){if(e instanceof s&&e.soul)this.put({[e.soul]:{"#":e.soul}},t);else{if(!(e&&e._&&e._["#"]))throw new Error("set() is only partially supported");this.put({[e&&e._&&e._["#"]]:e},t)}return this}not(e){return this.promise().then(t=>void 0===t&&e(this.key)),this}opt(e){return e&&(this._opt=Object.assign(Object.assign({},this._opt),e)),this._parent?Object.assign(Object.assign({},this._parent.opt()),this._opt):this._opt}once(e){return this.promise().then(t=>e(t,this.key)),this}on(e){return this.key,this._updateEvent.on(e),this._endQuery||(this._endQuery=this._chain.graph.query(this.getPath(),this._onQueryResponse.bind(this))),this._hasReceived&&e(this._lastValue,this.key),this}off(e){return e?(this._updateEvent.off(e),this._endQuery&&!this._updateEvent.listenerCount()&&this._endQuery()):(this._endQuery&&this._endQuery(),this._updateEvent.reset()),this}promise(e={timeout:0}){return new Promise(t=>{const n=e=>{t(e),this.off(n)};this.on(n),e.timeout&&setTimeout(()=>t(),e.timeout)})}then(e){return this.promise().then(e)}map(){throw new Error("map() isn't supported yet")}path(e){throw new Error("No plans to support this")}open(e){throw new Error("No plans to support this")}load(e){throw new Error("No plans to support this")}bye(){throw new Error("No plans to support this")}later(){throw new Error("No plans to support this")}unset(e){throw new Error("No plans to support this")}_onQueryResponse(e){this._updateEvent.trigger(e,this.key),this._lastValue=e,this._hasReceived=!0}}n.ChainGunLink=s},{"./ControlFlow/GunEvent":4}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.GunEvent=class{constructor(e="GunEvent"){this.name=e,this._listeners=[],this.listenerCount=this.listenerCount.bind(this),this.on=this.on.bind(this),this.off=this.off.bind(this),this.trigger=this.trigger.bind(this)}listenerCount(){return this._listeners.length}on(e){return-1!==this._listeners.indexOf(e)?this:(this._listeners.push(e),this)}off(e){const t=this._listeners.indexOf(e);return-1!==t&&this._listeners.splice(t,1),this}reset(){return this._listeners=[],this}trigger(e,t,n){return this._listeners.forEach(r=>r(e,t,n)),this}}},{}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("./GunEvent"),s=e("./GunQueue"),o=e("./MiddlewareSystem");n.GunProcessQueue=class extends s.GunQueue{constructor(e="GunProcessQueue",t="process_dupes"){super(e),this.alreadyProcessed=[],this.isProcessing=!1,this.processDupes=t,this.completed=new r.GunEvent(`${e}.processed`),this.emptied=new r.GunEvent(`${e}.emptied`),this.middleware=new o.MiddlewareSystem(`${e}.middleware`)}has(e){return super.has(e)||-1!==this.alreadyProcessed.indexOf(e)}async processNext(e,t){let n=this.dequeue();const r=n;n&&(n=await this.middleware.process(n,e,t),r&&"dont_process_dupes"===this.processDupes&&this.alreadyProcessed.push(r),n&&this.completed.trigger(n))}enqueueMany(e){return super.enqueueMany(e),this}async process(){if(!this.isProcessing&&this.count()){for(this.isProcessing=!0;this.count();)try{await this.processNext()}catch(e){console.error("Process Queue error",e.stack)}this.emptied.trigger(!0),this.isProcessing=!1}}}},{"./GunEvent":4,"./GunQueue":6,"./MiddlewareSystem":7}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.GunQueue=class{constructor(e="GunQueue"){this.name=e,this._queue=[]}count(){return this._queue.length}has(e){return-1!==this._queue.indexOf(e)}enqueue(e){return this.has(e)?this:(this._queue.splice(0,0,e),this)}dequeue(){return this._queue.pop()}enqueueMany(e){const t=e.filter(e=>!this.has(e));return t.length&&this._queue.splice(0,0,...t.slice().reverse()),this}}},{}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.MiddlewareSystem=class{constructor(e="MiddlewareSystem"){this.name=e,this._middlewareFunctions=[]}use(e){return-1!==this._middlewareFunctions.indexOf(e)?this:(this._middlewareFunctions.push(e),this)}unuse(e){const t=this._middlewareFunctions.indexOf(e);return-1!==t&&this._middlewareFunctions.splice(t,1),this}async process(e,t,n){let r=e;for(const e of this._middlewareFunctions){if(!r)return;r=await e(r,t,n)}return r}}},{}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("@chaingun/crdt"),s=e("../ControlFlow/GunEvent"),o=e("./GunGraphNode"),i=e("./GunGraphUtils");n.GunGraph=class{constructor(){this.id=i.generateMessageId(),this._receiveGraphData=this._receiveGraphData.bind(this),this.__onConnectorStatus=this.__onConnectorStatus.bind(this),this.activeConnectors=0,this.events={get:new s.GunEvent("request soul"),graphData:new s.GunEvent("graph data"),off:new s.GunEvent("off event"),put:new s.GunEvent("put data")},this._opt={},this._graph={},this._nodes={},this._connectors=[],this._readMiddleware=[],this._writeMiddleware=[]}opt(e){return this._opt=Object.assign(Object.assign({},this._opt),e),this}connect(e){return-1!==this._connectors.indexOf(e)?this:(this._connectors.push(e.connectToGraph(this)),e.events.connection.on(this.__onConnectorStatus),e.events.graphData.on(this._receiveGraphData),e.isConnected&&this.activeConnectors++,this)}disconnect(e){const t=this._connectors.indexOf(e);return e.events.graphData.off(this._receiveGraphData),e.events.connection.off(this.__onConnectorStatus),-1!==t&&this._connectors.splice(t,1),e.isConnected&&this.activeConnectors--,this}use(e,t="read"){return"read"===t?this._readMiddleware.push(e):"write"===t&&this._writeMiddleware.push(e),this}unuse(e,t="read"){if("read"===t){const t=this._readMiddleware.indexOf(e);-1!==t&&this._readMiddleware.splice(t,1)}else if("write"===t){const t=this._writeMiddleware.indexOf(e);-1!==t&&this._writeMiddleware.splice(t,1)}return this}query(e,t){let n,r=[];const s=()=>{const{souls:o,value:u,complete:c}=i.getPathData(e,this._graph),[a,h]=i.diffSets(r,o);(c&&void 0===n||void 0!==u&&u!==n)&&(n=u,t(u,e[e.length-1]));for(const e of a)this._requestSoul(e,s);for(const e of h)this._unlistenSoul(e,s);r=o};return s(),()=>{for(const e of r)this._unlistenSoul(e,s)}}async putPath(e,t,n,r){if(!e.length)throw new Error("No path specified");const s=await this.getPathSouls(e);if(s.length===e.length)return void this.put({[s[s.length-1]]:t},n);const o=e.slice(0,s.length),i=e.slice(s.length);let u=s[s.length-1];const c={};for(let e=0;e<i.length;e++){const n=(new Date).getTime(),s=i[e];let a,h="";if(e===i.length-1)a=t;else{if(!r)throw new Error("Must specify uuid function to put to incomplete path");a={"#":h=await r([...o,...i.slice(0,e+1)])}}c[u]={_:{"#":u,">":{[s]:n}},[s]:a},h&&(u=h)}this.put(c,n)}getPathSouls(e){return new Promise(t=>{if(1===e.length)return void t(e);let n=[];const r=()=>{for(const e of n)this._unlistenSoul(e,s);n=[]},s=()=>{const{souls:o,complete:u}=i.getPathData(e,this._graph),[c,a]=i.diffSets(n,o);if(u)r(),t(o);else{for(const e of c)this._requestSoul(e,s);for(const e of a)this._unlistenSoul(e,s)}n=o};s()})}get(e,t,n){const r=n||i.generateMessageId();return this.events.get.trigger({cb:t,msgId:r,soul:e}),()=>this.events.off.trigger(r)}put(e,t,n){let s=i.flattenGraphData(r.addMissingState(e));const o=n||i.generateMessageId();return(async()=>{for(const e of this._writeMiddleware){if(!s)return;s=await e(s,this._graph)}s&&(this.events.put.trigger({cb:t,graph:s,msgId:o}),this._receiveGraphData(s))})(),()=>this.events.off.trigger(o)}eachConnector(e){for(const t of this._connectors)e(t);return this}async _receiveGraphData(e,t,n){let s=e;for(const e of this._readMiddleware){if(!s)return;s=await e(s,this._graph)}if(s){for(const e in s){if(!e)continue;const t=this._nodes[e];t&&t.receive(this._graph[e]=r.mergeGunNodes(this._graph[e],s[e],this._opt.mutable?"mutable":"immutable"))}this.events.graphData.trigger(s,t,n)}}_node(e){return this._nodes[e]=this._nodes[e]||new o.GunGraphNode(this,e,this._receiveGraphData)}_requestSoul(e,t){return this._node(e).get(t),this}_unlistenSoul(e,t){const n=this._nodes[e];return n?(n.off(t),n.listenerCount()<=0&&(n.off(),this._forgetSoul(e)),this):this}_forgetSoul(e){const t=this._nodes[e];return t&&(t.off(),delete this._nodes[e]),delete this._graph[e],this}__onConnectorStatus(e){e?this.activeConnectors++:this.activeConnectors--}}},{"../ControlFlow/GunEvent":4,"./GunGraphNode":9,"./GunGraphUtils":10,"@chaingun/crdt":16}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("../ControlFlow/GunEvent");n.GunGraphNode=class{constructor(e,t,n){this._onDirectQueryReply=this._onDirectQueryReply.bind(this),this._data=new r.GunEvent(`<GunGraphNode ${t}>`),this._graph=e,this._updateGraph=n,this.soul=t}listenerCount(){return this._data.listenerCount()}get(e){return e&&this.on(e),this._ask(),this}receive(e){return this._data.trigger(e,this.soul),this}on(e){return this._data.on(e),this}off(e){return e?this._data.off(e):this._data.reset(),this._endCurQuery&&!this._data.listenerCount()&&(this._endCurQuery(),this._endCurQuery=void 0),this}_ask(){return this._endCurQuery?this:(this._endCurQuery=this._graph.get(this.soul,this._onDirectQueryReply),this)}_onDirectQueryReply(e){e.put||this._updateGraph({[this.soul]:void 0},e["@"])}}},{"../ControlFlow/GunEvent":4}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("@chaingun/crdt"),s=e("../ChainGunLink");function o(e){const t=Object.assign({},e);let n={};const i=e&&e._&&e._["#"];for(const i in e){if("_"===i)continue;const u=e[i];if("object"!=typeof u||null===u)continue;if(u.soul){const e={"#":u.soul};t[i]=e;continue}let c=u&&u._&&u._["#"];if(u instanceof s.ChainGunLink&&u.soul&&(c=u.soul),c){const e={"#":c};t[i]=e;const s=r.addMissingState(o(u)),a=r.diffGunCRDT(s,n);n=a?r.mergeGraph(n,a):n}}const u={[i]:t},c=r.addMissingState(u),a=r.diffGunCRDT(c,n);return n=a?r.mergeGraph(n,a):n}n.generateMessageId=function(){return Math.random().toString(36).slice(2)},n.diffSets=function(e,t){return[t.filter(t=>-1===e.indexOf(t)),e.filter(e=>-1===t.indexOf(e))]},n.nodeToGraph=o,n.flattenGraphData=function(e){const t=[];let n={};for(const n in e){if(!n)continue;const r=e[n];r&&t.push(o(r))}for(const e of t){const t=r.diffGunCRDT(e,n);n=t?r.mergeGraph(n,t):n}return n},n.getPathData=function e(t,n){const r=t[t.length-1];if(1===t.length)return{complete:r in n,souls:t,value:n[r]};const{value:s,souls:o,complete:i}=e(t.slice(0,t.length-1),n);if("object"!=typeof s)return{complete:i||void 0!==s,souls:o,value:void 0};const u=s[r];if(!u)return{complete:!0,souls:o,value:u};const c=u["#"];return c?{complete:c in n,souls:[...o,c],value:n[c]}:{complete:!0,souls:o,value:u}}},{"../ChainGunLink":3,"@chaingun/crdt":16}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("../ControlFlow/GunEvent"),s=e("../ControlFlow/GunProcessQueue");n.GunGraphConnector=class{constructor(e="GunGraphConnector"){this.isConnected=!1,this.name=e,this.put=this.put.bind(this),this.off=this.off.bind(this),this.inputQueue=new s.GunProcessQueue(`${e}.inputQueue`),this.outputQueue=new s.GunProcessQueue(`${e}.outputQueue`),this.events={connection:new r.GunEvent(`${e}.events.connection`),graphData:new r.GunEvent(`${e}.events.graphData`),receiveMessage:new r.GunEvent(`${e}.events.receiveMessage`)},this.__onConnectedChange=this.__onConnectedChange.bind(this),this.events.connection.on(this.__onConnectedChange)}connectToGraph(e){return e.events.off.on(this.off),this}off(e){return this}sendPutsFromGraph(e){return e.events.put.on(this.put),this}sendRequestsFromGraph(e){return e.events.get.on(e=>{this.get(e)}),this}waitForConnection(){return this.isConnected?Promise.resolve():new Promise(e=>{const t=n=>{n&&(e(),this.events.connection.off(t))};this.events.connection.on(t)})}put(e){return()=>{}}get(e){return()=>{}}send(e){return this.outputQueue.enqueueMany(e),this.isConnected&&this.outputQueue.process(),this}ingest(e){return this.inputQueue.enqueueMany(e).process(),this}__onConnectedChange(e){e?(this.isConnected=!0,this.outputQueue.process()):this.isConnected=!1}}},{"../ControlFlow/GunEvent":4,"../ControlFlow/GunProcessQueue":5}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("../Graph/GunGraphUtils"),s=e("./GunGraphWireConnector"),o=()=>void 0;n.GunGraphConnectorFromAdapter=class extends s.GunGraphWireConnector{constructor(e,t="GunGraphConnectorFromAdapter"){super(t),this.adapter=e}get({soul:e,cb:t,msgId:n=""}){return this.adapter.get(e).then(t=>({"#":r.generateMessageId(),"@":n,put:t?{[e]:t}:void 0})).catch(e=>(console.warn(e.stack||e),{"#":r.generateMessageId(),"@":n,err:"Error fetching node"})).then(e=>{this.ingest([e]),t&&t(e)}),o}put({graph:e,msgId:t="",cb:n}){return this.adapter.put(e).then(()=>({"#":r.generateMessageId(),"@":t,err:null,ok:!0})).catch(e=>(console.warn(e.stack||e),{"#":r.generateMessageId(),"@":t,err:"Error saving put",ok:!1})).then(e=>{this.ingest([e]),n&&n(e)}),o}}},{"../Graph/GunGraphUtils":10,"./GunGraphWireConnector":13}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("../Graph/GunGraphUtils"),s=e("./GunGraphConnector");n.GunGraphWireConnector=class extends s.GunGraphConnector{constructor(e="GunWireProtocol"){super(e),this._callbacks={},this._onProcessedInput=this._onProcessedInput.bind(this),this.inputQueue.completed.on(this._onProcessedInput)}off(e){return super.off(e),delete this._callbacks[e],this}put({graph:e,msgId:t="",replyTo:n="",cb:r}){if(!e)return()=>{};const s={put:e};return t&&(s["#"]=t),n&&(s["@"]=n),this.req(s,r)}get({soul:e,cb:t,msgId:n=""}){const r={get:{"#":e}};return n&&(r["#"]=n),this.req(r,t)}req(e,t){const n=e["#"]=e["#"]||r.generateMessageId();return t&&(this._callbacks[n]=t),this.send([e]),()=>{this.off(n)}}_onProcessedInput(e){if(!e)return;const t=e["#"],n=e["@"];if(e.put&&this.events.graphData.trigger(e.put,t,n),n){const t=this._callbacks[n];t&&t(e)}this.events.receiveMessage.trigger(e)}}},{"../Graph/GunGraphUtils":10,"./GunGraphConnector":11}],14:[function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0});const s=r(e("reconnecting-websocket")),o=e("./GunGraphWireConnector");n.WebSocketGraphConnector=class extends o.GunGraphWireConnector{constructor(e,t=WebSocket){super(`<WebSocketGraphConnector ${e}>`),this.url=e,this.outputQueue.completed.on(this._onOutputProcessed.bind(this)),this._ws=this._connectWebSocket(t)}_connectWebSocket(e=WebSocket){const t=new s.default(this.url.replace(/^http/,"ws"),[],{WebSocket:e});return t.addEventListener("message",this._onReceiveSocketData.bind(this)),t.addEventListener("open",()=>this.events.connection.trigger(!0)),t.addEventListener("close",()=>this.events.connection.trigger(!1)),t}_sendToWebsocket(e){return e.length?(1===e.length?this._ws.send(JSON.stringify(e[0])):e.length>0&&this._ws.send(JSON.stringify(e)),e):e}_onOutputProcessed(e){e&&this._sendToWebsocket([e])}_onReceiveSocketData(e){const t=e.data,n=JSON.parse(t);Array.isArray(n)?this.ingest(n.map(e=>"string"==typeof e?JSON.parse(e):e)):this.ingest([n])}}},{"./GunGraphWireConnector":13,"reconnecting-websocket":17}],15:[function(e,t,n){"use strict";function r(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),r(e("@chaingun/crdt")),r(e("./Graph/GunGraphUtils"));var s=e("./ChainGunClient");n.ChainGunClient=s.ChainGunClient;var o=e("./Graph/GunGraph");n.GunGraph=o.GunGraph;var i=e("./ChainGunLink");n.ChainGunLink=i.ChainGunLink;var u=e("./ControlFlow/GunEvent");n.GunEvent=u.GunEvent;var c=e("./ControlFlow/GunQueue");n.GunQueue=c.GunQueue;var a=e("./ControlFlow/GunProcessQueue");n.GunProcessQueue=a.GunProcessQueue;var h=e("./Transports/GunGraphConnector");n.GunGraphConnector=h.GunGraphConnector;var l=e("./Transports/GunGraphWireConnector");n.GunGraphWireConnector=l.GunGraphWireConnector;var p=e("./Transports/WebSocketGraphConnector");n.WebSocketGraphConnector=p.WebSocketGraphConnector;var d=e("./Transports/GunGraphConnectorFromAdapter");n.GunGraphConnectorFromAdapter=d.GunGraphConnectorFromAdapter},{"./ChainGunClient":2,"./ChainGunLink":3,"./ControlFlow/GunEvent":4,"./ControlFlow/GunProcessQueue":5,"./ControlFlow/GunQueue":6,"./Graph/GunGraph":8,"./Graph/GunGraphUtils":10,"./Transports/GunGraphConnector":11,"./Transports/GunGraphConnectorFromAdapter":12,"./Transports/GunGraphWireConnector":13,"./Transports/WebSocketGraphConnector":14,"@chaingun/crdt":16}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r={};n.addMissingState=function(e){const t=Object.assign({},e),n=(new Date).getTime();for(const r in e){if(!r)continue;const s=e[r];if(!s)continue;const o=s._=s._||{};o["#"]=r;const i=o[">"]=o[">"]||{};for(const e in s)"_"!==e&&(i[e]=i[e]||n);t[r]=s}return t};const s={Lexical:JSON.stringify,futureGrace:6e5};function o(e,t,n="immutable"){if(!e)return t;if(!t)return e;const r=e._||{},s=r[">"]||{},o=(t._||{})[">"]||{};if("mutable"===n){r[">"]=s,e._=r;for(const n in o)n&&(e[n]=t[n],s[n]=o[n]);return e}return Object.assign(Object.assign(Object.assign({},e),t),{_:{"#":r["#"],">":Object.assign(Object.assign({},r[">"]),t._[">"])}})}n.diffGunCRDT=function(e,t,n=s){const{machineState:o=(new Date).getTime(),futureGrace:i=s.futureGrace,Lexical:u=s.Lexical}=n||r,c=o+i,a={};for(const n in e){if(!n)continue;const s=t[n],o=e[n],i=s&&s._&&s._[">"]||r,h=o&&o._&&o._[">"]||r;if(!o){n in t||(a[n]=o);continue}let l=!1;const p={_:{"#":n,">":{}}};for(const e in h){if(!e)continue;const t=i[e],n=h[e];if(!(n>c)&&n&&!(t&&t>=n)){if(t===n){const t=s&&s[e]||void 0;if(u(o[e])<=u(t))continue}p[e]=o[e],p._[">"][e]=n,l=!0}}l&&(a[n]=p)}return Object.keys(a)?a:void 0},n.mergeGunNodes=o,n.mergeGraph=function(e,t,n="immutable"){const r=n?e:Object.assign({},e);for(const s in t)s&&(r[s]=o(e[s],t[s],n));return r}},{}],17:[function(e,t,n){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function s(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,s,o=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(s)throw s.error}}return i}var i=function(){return function(e,t){this.target=t,this.type=e}}(),u=function(e){function t(t,n){var r=e.call(this,"error",n)||this;return r.message=t.message,r.error=t,r}return s(t,e),t}(i),c=function(e){function t(t,n,r){void 0===t&&(t=1e3),void 0===n&&(n="");var s=e.call(this,"close",r)||this;return s.wasClean=!0,s.code=t,s.reason=n,s}return s(t,e),t}(i),a=function(){if("undefined"!=typeof WebSocket)return WebSocket},h={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},l=function(){function e(e,t,n){var r=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){r._debug("open event");var t=r._options.minUptime,n=void 0===t?h.minUptime:t;clearTimeout(r._connectTimeout),r._uptimeTimeout=setTimeout(function(){return r._acceptOpen()},n),r._ws.binaryType=r._binaryType,r._messageQueue.forEach(function(e){return r._ws.send(e)}),r._messageQueue=[],r.onopen&&r.onopen(e),r._listeners.open.forEach(function(t){return r._callEventListener(e,t)})},this._handleMessage=function(e){r._debug("message event"),r.onmessage&&r.onmessage(e),r._listeners.message.forEach(function(t){return r._callEventListener(e,t)})},this._handleError=function(e){r._debug("error event",e.message),r._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),r.onerror&&r.onerror(e),r._debug("exec error listeners"),r._listeners.error.forEach(function(t){return r._callEventListener(e,t)}),r._connect()},this._handleClose=function(e){r._debug("close event"),r._clearTimeouts(),r._shouldReconnect&&r._connect(),r.onclose&&r.onclose(e),r._listeners.close.forEach(function(t){return r._callEventListener(e,t)})},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?h.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,r=this._listeners[e.type];if(r)try{for(var s=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(r),o=s.next();!o.done;o=s.next()){var i=o.value;this._callEventListener(e,i)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(o(arguments[t]));return e}(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?h.reconnectionDelayGrowFactor:t,r=e.minReconnectionDelay,s=void 0===r?h.minReconnectionDelay:r,o=e.maxReconnectionDelay,i=void 0===o?h.maxReconnectionDelay:o,u=0;return this._retryCount>0&&(u=s*Math.pow(n,this._retryCount-1))>i&&(u=i),this._debug("next delay",u),u},e.prototype._wait=function(){var e=this;return new Promise(function(t){setTimeout(t,e._getNextDelay())})},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,r=void 0===n?h.maxRetries:n,s=t.connectionTimeout,o=void 0===s?h.connectionTimeout:s,i=t.WebSocket,u=void 0===i?a():i;if(this._retryCount>=r)this._debug("max retries reached",this._retryCount,">=",r);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(c=u)||!c||2!==c.CLOSING)throw Error("No valid WebSocket class provided");var c;this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new u(t,e._protocols):new u(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},o))})}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new u(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new c(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();t.exports=l},{}]},{},[1]);
